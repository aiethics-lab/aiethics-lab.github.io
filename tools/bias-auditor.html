<!DOCTYPE html>
<html class="dark" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dataset Bias Auditor | AI Ethics Toolkit</title>
    <meta name="description"
        content="Audit datasets for representation bias, analyze class distributions, and identify potential fairness issues." />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet" />
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: { "primary": "#137fec", "primary-hover": "#0f6bd1", "background-light": "#f6f7f8", "background-dark": "#101922", "surface-dark": "#182430", "surface-dark-lighter": "#212e3b" },
                    fontFamily: { "display": ["Space Grotesk", "sans-serif"] },
                }
            },
        }
    </script>
    <style>
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #101922;
        }

        ::-webkit-scrollbar-thumb {
            background: #2d3f50;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #137fec;
        }
    </style>
</head>

<body
    class="bg-background-light dark:bg-background-dark text-slate-800 dark:text-slate-200 font-display min-h-screen flex antialiased selection:bg-primary selection:text-white">
    <!-- Sidebar -->
    <aside
        class="w-64 flex-shrink-0 fixed h-full z-20 bg-white dark:bg-surface-dark border-r border-slate-200 dark:border-slate-800 flex flex-col transition-all duration-300">
        <div class="h-16 flex items-center px-6 border-b border-slate-200 dark:border-slate-800">
            <span class="material-icons-outlined text-primary text-3xl mr-2">psychology</span>
            <span class="text-xl font-bold tracking-tight dark:text-white">AI Ethics Toolkit</span>
        </div>
        <nav class="flex-1 overflow-y-auto py-6 px-3 space-y-1">
            <a class="flex items-center px-3 py-2.5 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark-lighter transition-colors group"
                href="../index.html">
                <span
                    class="material-icons-outlined mr-3 text-2xl group-hover:scale-110 transition-transform">grid_view</span>
                Toolkit Overview
            </a>
            <div class="pt-4 pb-2 px-3">
                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Tools</p>
            </div>
            <a class="flex items-center px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark-lighter transition-colors group text-sm"
                href="word-embeddings.html"><span
                    class="material-icons-outlined mr-3 text-xl group-hover:text-primary transition-colors">scatter_plot</span>
                Word Embeddings</a>
            <a class="flex items-center px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark-lighter transition-colors group text-sm"
                href="explainability-lab.html"><span
                    class="material-icons-outlined mr-3 text-xl group-hover:text-primary transition-colors">visibility</span>
                Explainability Lab</a>
            <a class="flex items-center px-3 py-2 rounded-lg bg-primary/10 text-primary font-medium group text-sm"
                href="bias-auditor.html"><span class="material-icons-outlined mr-3 text-xl">saved_search</span> Bias
                Auditor</a>
            <a class="flex items-center px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark-lighter transition-colors group text-sm"
                href="adversarial-sandbox.html"><span
                    class="material-icons-outlined mr-3 text-xl group-hover:text-primary transition-colors">security</span>
                Adversarial Sandbox</a>
            <a class="flex items-center px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark-lighter transition-colors group text-sm"
                href="filter-bubble.html"><span
                    class="material-icons-outlined mr-3 text-xl group-hover:text-primary transition-colors">bubble_chart</span>
                Filter Bubble Sim</a>
            <a class="flex items-center px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark-lighter transition-colors group text-sm"
                href="privacy-lab.html"><span
                    class="material-icons-outlined mr-3 text-xl group-hover:text-primary transition-colors">vpn_key</span>
                Privacy Lab</a>
            <a class="flex items-center px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark-lighter transition-colors group text-sm"
                href="value-alignment.html"><span
                    class="material-icons-outlined mr-3 text-xl group-hover:text-primary transition-colors">balance</span>
                Value Alignment</a>
            <a class="flex items-center px-3 py-2 rounded-lg text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-surface-dark-lighter transition-colors group text-sm"
                href="proxy-detector.html"><span
                    class="material-icons-outlined mr-3 text-xl group-hover:text-primary transition-colors">find_replace</span>
                Proxy Detector</a>
        </nav>
        <div class="border-t border-slate-200 dark:border-slate-800 p-4">
            <p class="text-[10px] text-slate-400 mb-2">Â© 2026 <a href="https://hamedyaghoobian.com" class="text-primary hover:underline">Hamed Yaghoobian</a></p>
            <div class="flex items-center justify-between text-xs text-slate-500 dark:text-slate-400"><span>Version
                    2.1.0</span><a class="hover:text-primary transition-colors" href="#">Legal</a></div>
        </div>
    </aside>

    <main class="flex-1 ml-64 p-8 overflow-y-auto h-screen">
        <header class="flex justify-between items-center mb-8">
            <div>
                <div class="flex items-center mb-1">
                    <a href="../index.html"
                        class="text-slate-400 hover:text-primary transition-colors text-sm mr-2">Toolkit</a>
                    <span class="material-icons-outlined text-slate-400 text-sm">chevron_right</span>
                    <span class="text-primary text-sm ml-2">Bias Auditor</span>
                </div>
                <h1 class="text-3xl font-bold text-slate-900 dark:text-white">Dataset Bias Auditor</h1>
                <p class="text-slate-500 dark:text-slate-400 mt-1">Upload a CSV dataset or use a sample to analyze bias
                    and representation imbalances.</p>
            </div>
            <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="themeToggle" class="sr-only peer" checked />
                <div
                    class="w-11 h-6 bg-slate-300 rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary">
                </div>
                <span class="ml-2 text-sm text-slate-500 dark:text-slate-400"><span
                        class="material-icons-outlined text-sm align-middle">dark_mode</span></span>
            </label>
        </header>

        <!-- Data Source -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
            <div
                class="lg:col-span-3 bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700/60 rounded-xl p-6">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-4">
                    <span class="material-icons-outlined text-primary mr-2 align-middle">upload_file</span> Data Source
                </h3>
                <div class="flex gap-4 mb-4">
                    <label class="flex-1 cursor-pointer">
                        <div class="border-2 border-dashed border-slate-300 dark:border-slate-600 rounded-xl p-6 text-center hover:border-primary transition-colors"
                            id="dropZone">
                            <span class="material-icons-outlined text-4xl text-slate-400 mb-2 block">cloud_upload</span>
                            <p class="text-sm text-slate-500 dark:text-slate-400">Drag & drop a CSV file or <span
                                    class="text-primary font-medium">browse</span></p>
                            <input type="file" id="csvUpload" accept=".csv" class="hidden" />
                        </div>
                    </label>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadSampleDataset('credit')"
                        class="px-4 py-2 rounded-lg bg-blue-500/10 text-blue-500 hover:bg-blue-500/20 text-sm font-medium transition-colors">
                        <span class="material-icons-outlined text-sm align-middle mr-1">credit_card</span> Credit Risk
                    </button>
                    <button onclick="loadSampleDataset('hiring')"
                        class="px-4 py-2 rounded-lg bg-purple-500/10 text-purple-500 hover:bg-purple-500/20 text-sm font-medium transition-colors">
                        <span class="material-icons-outlined text-sm align-middle mr-1">work</span> Hiring Data
                    </button>
                    <button onclick="loadSampleDataset('recidivism')"
                        class="px-4 py-2 rounded-lg bg-red-500/10 text-red-500 hover:bg-red-500/20 text-sm font-medium transition-colors">
                        <span class="material-icons-outlined text-sm align-middle mr-1">gavel</span> Recidivism
                    </button>
                </div>
            </div>

            <!-- Audit Config -->
            <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700/60 rounded-xl p-6">
                <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300 mb-3">Audit Configuration</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-xs text-slate-500 dark:text-slate-400 block mb-1">Protected Attribute</label>
                        <select id="protectedAttr"
                            class="w-full px-3 py-1.5 text-sm rounded-lg bg-slate-50 dark:bg-surface-dark-lighter border border-slate-200 dark:border-slate-700 focus:ring-primary focus:border-primary">
                            <option>Load a dataset first</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 dark:text-slate-400 block mb-1">Target Variable</label>
                        <select id="targetVar"
                            class="w-full px-3 py-1.5 text-sm rounded-lg bg-slate-50 dark:bg-surface-dark-lighter border border-slate-200 dark:border-slate-700 focus:ring-primary focus:border-primary">
                            <option>Load a dataset first</option>
                        </select>
                    </div>
                    <button onclick="runAudit()"
                        class="w-full py-2 bg-primary hover:bg-primary-hover text-white font-medium rounded-lg transition-colors text-sm flex items-center justify-center">
                        <span class="material-icons-outlined mr-1 text-base">play_arrow</span> Run Audit
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Preview -->
        <div id="dataPreview"
            class="hidden mb-6 bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700/60 rounded-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white">
                    <span class="material-icons-outlined text-primary mr-2 align-middle">table_chart</span> Data Preview
                </h3>
                <span id="dataInfo" class="text-sm text-slate-500 dark:text-slate-400"></span>
            </div>
            <div class="overflow-x-auto rounded-lg border border-slate-200 dark:border-slate-700">
                <table id="previewTable" class="w-full text-sm">
                    <thead id="previewHead"
                        class="bg-slate-50 dark:bg-surface-dark-lighter text-slate-600 dark:text-slate-400"></thead>
                    <tbody id="previewBody" class="divide-y divide-slate-200 dark:divide-slate-700"></tbody>
                </table>
            </div>
        </div>

        <!-- Audit Results -->
        <div id="auditResults" class="hidden space-y-6">
            <!-- Alerts -->
            <div id="alerts" class="space-y-3"></div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Distribution Chart -->
                <div
                    class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700/60 rounded-xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                        <span class="material-icons-outlined text-orange-500 mr-2 align-middle">bar_chart</span> Class
                        Distribution
                    </h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Distribution of the target variable
                        across protected attribute groups.</p>
                    <div id="distributionChart" class="h-[350px]"></div>
                </div>

                <!-- Representation -->
                <div
                    class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700/60 rounded-xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                        <span class="material-icons-outlined text-blue-500 mr-2 align-middle">pie_chart</span> Group
                        Representation
                    </h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Proportion of each group in the dataset.
                    </p>
                    <div id="representationChart" class="h-[350px]"></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Correlation Matrix -->
                <div
                    class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700/60 rounded-xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                        <span class="material-icons-outlined text-purple-500 mr-2 align-middle">grid_on</span>
                        Correlation Heatmap
                    </h3>
                    <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Pearson correlation between numeric
                        features.</p>
                    <div id="correlationChart" class="h-[400px]"></div>
                </div>

                <!-- Fairness Metrics -->
                <div
                    class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700/60 rounded-xl p-6">
                    <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                        <span class="material-icons-outlined text-green-500 mr-2 align-middle">assessment</span>
                        Fairness Metrics (7 Tests)
                    </h3>
                    <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">Comprehensive fairness evaluation using
                        multiple complementary metrics.</p>
                    <div id="fairnessMetrics" class="space-y-4"></div>
                </div>
            </div>

            <!-- Intersectional Analysis -->
            <div class="bg-white dark:bg-surface-dark border border-slate-200 dark:border-slate-700/60 rounded-xl p-6">
                <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-2">
                    <span class="material-icons-outlined text-pink-500 mr-2 align-middle">diversity_3</span>
                    Intersectional Analysis
                </h3>
                <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Bias can be amplified at intersections of
                    multiple attributes (e.g., race Ã— gender). This analysis checks for compound effects.</p>
                <div id="intersectionalResults" class="space-y-3"></div>
            </div>

            <!-- Export -->
            <div class="flex justify-end gap-3">
                <button onclick="exportReport()"
                    class="px-5 py-2.5 bg-primary hover:bg-primary-hover text-white font-medium rounded-lg transition-colors flex items-center text-sm">
                    <span class="material-icons-outlined mr-2 text-base">download</span> Export Report (HTML)
                </button>
            </div>
        </div>
    </main>

    <script>
        // ==================== THEME ====================
        const themeToggle = document.getElementById('themeToggle');
        function setTheme(dark) { document.documentElement.classList.toggle('dark', dark); document.documentElement.classList.toggle('light', !dark); localStorage.setItem('ethicsToolkitTheme', dark ? 'dark' : 'light'); }
        const savedTheme = localStorage.getItem('ethicsToolkitTheme');
        if (savedTheme === 'light') { setTheme(false); themeToggle.checked = false; }
        themeToggle.addEventListener('change', () => setTheme(themeToggle.checked));

        // ==================== STATE ====================
        let currentData = null;
        let currentColumns = [];

        // ==================== SAMPLE DATASETS (REAL CSV FILES) ====================
        const SAMPLE_DATASETS = {
            credit: '../data/credit-risk-sample.csv',
            hiring: '../data/hiring-sample.csv',
            recidivism: '../data/recidivism-sample.csv'
        };

        function loadSampleDataset(type) {
            const url = SAMPLE_DATASETS[type];
            if (!url) return;

            // Show loading state on the button
            const btn = event.target.closest('button');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<span class="material-icons-outlined text-sm align-middle mr-1 animate-spin">sync</span> Loading...';
            btn.disabled = true;

            Papa.parse(url, {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    processData(results.data);
                },
                error: (err) => {
                    btn.innerHTML = originalHTML;
                    btn.disabled = false;
                    alert('Failed to load sample dataset: ' + err.message);
                }
            });
        }

        // ==================== FILE UPLOAD ====================
        const csvUpload = document.getElementById('csvUpload');
        const dropZone = document.getElementById('dropZone');

        csvUpload.addEventListener('change', (e) => {
            if (e.target.files.length) parseCSV(e.target.files[0]);
        });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('border-primary'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-primary'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-primary');
            if (e.dataTransfer.files.length) parseCSV(e.dataTransfer.files[0]);
        });

        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => processData(results.data)
            });
        }

        function processData(data) {
            currentData = data;
            currentColumns = Object.keys(data[0]);
            updateDropdowns();
            showPreview();
        }

        function updateDropdowns() {
            const protectedAttr = document.getElementById('protectedAttr');
            const targetVar = document.getElementById('targetVar');

            const categoricalCols = currentColumns.filter(col => {
                const vals = new Set(currentData.map(r => r[col]));
                return vals.size <= 10 && vals.size >= 2;
            });

            protectedAttr.innerHTML = categoricalCols.map(c => `<option value="${c}">${c}</option>`).join('');
            targetVar.innerHTML = categoricalCols.map(c => `<option value="${c}">${c}</option>`).join('');

            // Auto-select likely candidates
            const protCandidates = ['Gender', 'Race', 'Sex', 'gender', 'race'];
            const targetCandidates = ['Decision', 'Hired', 'Recidivism', 'Outcome', 'Label', 'Target', 'decision', 'outcome'];
            protCandidates.forEach(c => { if (categoricalCols.includes(c)) protectedAttr.value = c; });
            targetCandidates.forEach(c => { if (categoricalCols.includes(c)) targetVar.value = c; });
        }

        function showPreview() {
            document.getElementById('dataPreview').classList.remove('hidden');
            document.getElementById('dataInfo').textContent = `${currentData.length} rows Ã— ${currentColumns.length} columns`;

            const head = document.getElementById('previewHead');
            head.innerHTML = `<tr>${currentColumns.map(c => `<th class="px-4 py-2 text-left text-xs font-semibold uppercase tracking-wider">${c}</th>`).join('')}</tr>`;

            const body = document.getElementById('previewBody');
            body.innerHTML = currentData.slice(0, 8).map(row =>
                `<tr class="hover:bg-slate-50 dark:hover:bg-surface-dark-lighter transition-colors">${currentColumns.map(c =>
                    `<td class="px-4 py-2 text-sm text-slate-700 dark:text-slate-300">${row[c]}</td>`
                ).join('')}</tr>`
            ).join('');
        }

        // ==================== AUDIT ====================
        function runAudit() {
            if (!currentData) return;
            const protAttr = document.getElementById('protectedAttr').value;
            const target = document.getElementById('targetVar').value;

            document.getElementById('auditResults').classList.remove('hidden');

            renderDistributionChart(protAttr, target);
            renderRepresentationChart(protAttr);
            renderCorrelationHeatmap();
            renderFairnessMetrics(protAttr, target);
            renderIntersectionalAnalysis(protAttr, target);
            generateAlerts(protAttr, target);
        }

        function renderDistributionChart(protAttr, target) {
            const groups = {};
            currentData.forEach(row => {
                const g = row[protAttr];
                const t = row[target];
                if (!groups[g]) groups[g] = {};
                groups[g][t] = (groups[g][t] || 0) + 1;
            });

            const targetVals = [...new Set(currentData.map(r => r[target]))];
            const groupNames = Object.keys(groups);
            const isDark = document.documentElement.classList.contains('dark');
            const colors = ['#137fec', '#ec4899', '#22c55e', '#f59e0b', '#8b5cf6', '#06b6d4'];

            const traces = targetVals.map((tv, i) => ({
                type: 'bar',
                name: String(tv),
                x: groupNames,
                y: groupNames.map(g => groups[g][tv] || 0),
                marker: { color: colors[i % colors.length] }
            }));

            Plotly.newPlot('distributionChart', traces, {
                barmode: 'group',
                margin: { t: 10, l: 40, r: 10, b: 40 },
                paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                xaxis: { color: isDark ? '#94a3b8' : '#475569' },
                yaxis: { color: isDark ? '#94a3b8' : '#475569', title: 'Count' },
                legend: { font: { color: isDark ? '#94a3b8' : '#475569' } },
                font: { family: 'Space Grotesk' }
            }, { responsive: true, displayModeBar: false });
        }

        function renderRepresentationChart(protAttr) {
            const counts = {};
            currentData.forEach(row => { const g = row[protAttr]; counts[g] = (counts[g] || 0) + 1; });
            const isDark = document.documentElement.classList.contains('dark');

            Plotly.newPlot('representationChart', [{
                type: 'pie',
                labels: Object.keys(counts),
                values: Object.values(counts),
                hole: 0.4,
                marker: { colors: ['#137fec', '#ec4899', '#22c55e', '#f59e0b', '#8b5cf6', '#06b6d4'] },
                textfont: { color: isDark ? '#e2e8f0' : '#1e293b' }
            }], {
                margin: { t: 10, l: 10, r: 10, b: 10 },
                paper_bgcolor: 'transparent',
                legend: { font: { color: isDark ? '#94a3b8' : '#475569' } },
                font: { family: 'Space Grotesk' }
            }, { responsive: true, displayModeBar: false });
        }

        function renderCorrelationHeatmap() {
            const numericCols = currentColumns.filter(col =>
                currentData.every(row => typeof row[col] === 'number' || !isNaN(parseFloat(row[col])))
            );
            if (numericCols.length < 2) return;

            const data = numericCols.map(col => currentData.map(row => parseFloat(row[col]) || 0));
            const n = data[0].length;

            function pearson(x, y) {
                const mx = x.reduce((s, v) => s + v, 0) / n;
                const my = y.reduce((s, v) => s + v, 0) / n;
                let num = 0, dx = 0, dy = 0;
                for (let i = 0; i < n; i++) {
                    num += (x[i] - mx) * (y[i] - my);
                    dx += (x[i] - mx) ** 2;
                    dy += (y[i] - my) ** 2;
                }
                return dx && dy ? num / Math.sqrt(dx * dy) : 0;
            }

            const matrix = numericCols.map((_, i) => numericCols.map((_, j) => +pearson(data[i], data[j]).toFixed(3)));
            const isDark = document.documentElement.classList.contains('dark');

            Plotly.newPlot('correlationChart', [{
                type: 'heatmap',
                z: matrix,
                x: numericCols,
                y: numericCols,
                colorscale: [[0, '#3b82f6'], [0.5, '#f8fafc'], [1, '#ef4444']],
                zmin: -1, zmax: 1,
                text: matrix.map(row => row.map(v => v.toFixed(2))),
                texttemplate: '%{text}',
                textfont: { size: 10 }
            }], {
                margin: { t: 10, l: 80, r: 10, b: 60 },
                paper_bgcolor: 'transparent', plot_bgcolor: 'transparent',
                xaxis: { color: isDark ? '#94a3b8' : '#475569', tickangle: -45 },
                yaxis: { color: isDark ? '#94a3b8' : '#475569' },
                font: { family: 'Space Grotesk' }
            }, { responsive: true, displayModeBar: false });
        }

        function renderFairnessMetrics(protAttr, target) {
            const groups = {};
            const targetVals = [...new Set(currentData.map(r => r[target]))];
            const positiveVal = targetVals.find(v => /approved|hired|low|yes|1|positive/i.test(String(v)));

            currentData.forEach(row => {
                const g = row[protAttr];
                if (!groups[g]) groups[g] = { total: 0, positive: 0, tp: 0, fp: 0, tn: 0, fn: 0 };
                groups[g].total++;
                const isPositive = String(row[target]) === String(positiveVal);
                if (isPositive) groups[g].positive++;
                // For simplicity, approximate TP/FP/TN/FN using outcome as prediction stand-in
                // In a real audit youâ€™d compare predictions vs. actuals
                if (isPositive) { groups[g].tp++; } else { groups[g].tn++; }
            });

            const groupNames = Object.keys(groups);
            const rates = groupNames.map(g => ({
                name: g,
                rate: groups[g].positive / groups[g].total,
                total: groups[g].total,
                positive: groups[g].positive,
                tpr: groups[g].positive > 0 ? groups[g].tp / groups[g].positive : 0,
                fpr: (groups[g].total - groups[g].positive) > 0 ? groups[g].fp / (groups[g].total - groups[g].positive) : 0
            }));
            const maxRate = Math.max(...rates.map(r => r.rate));
            const minRate = Math.min(...rates.map(r => r.rate));
            const disparateImpact = maxRate > 0 ? minRate / maxRate : 1;
            const statParity = maxRate - minRate;

            // Equal Opportunity Difference (TPR gap)
            const tprs = rates.map(r => r.tpr);
            const eqOpp = Math.max(...tprs) - Math.min(...tprs);

            // Predictive Equality (FPR gap)
            const fprs = rates.map(r => r.fpr);
            const predEq = Math.max(...fprs) - Math.min(...fprs);

            // Equalized Odds (max of TPR gap and FPR gap)
            const eqOdds = Math.max(eqOpp, predEq);

            // Theil Index (between-group inequality)
            const totalN = currentData.length;
            const totalPos = rates.reduce((s, r) => s + r.positive, 0);
            const overallRate = totalPos / totalN;
            let theilIndex = 0;
            if (overallRate > 0) {
                rates.forEach(r => {
                    if (r.rate > 0 && r.total > 0) {
                        const weight = r.total / totalN;
                        theilIndex += weight * (r.rate / overallRate) * Math.log(r.rate / overallRate);
                    }
                });
            }

            // Chi-squared test for independence
            const observed = [];
            const expected = [];
            targetVals.forEach(tv => {
                const totalTV = currentData.filter(r => String(r[target]) === String(tv)).length;
                groupNames.forEach(g => {
                    const obs = currentData.filter(r => r[protAttr] === g && String(r[target]) === String(tv)).length;
                    const exp = (groups[g].total * totalTV) / totalN;
                    observed.push(obs);
                    expected.push(exp);
                });
            });
            let chiSq = 0;
            for (let i = 0; i < observed.length; i++) {
                if (expected[i] > 0) chiSq += (observed[i] - expected[i]) ** 2 / expected[i];
            }
            const df = (groupNames.length - 1) * (targetVals.length - 1);
            // Approximate p-value using chi-squared CDF (simplified)
            const chiPValue = df > 0 ? Math.exp(-chiSq / 2) : 1; // rough approximation

            const metrics = [
                { name: 'Disparate Impact Ratio', value: disparateImpact, threshold: 0.8, direction: '>=', desc: 'Min/Max selection rate ratio. Should be â‰¥ 0.8 (80% rule)', icon: 'gavel' },
                { name: 'Statistical Parity Diff', value: statParity, threshold: 0.1, direction: '<=', desc: 'Max rate diff between groups. Should be â‰¤ 0.1', icon: 'balance' },
                { name: 'Equal Opportunity Diff', value: eqOpp, threshold: 0.1, direction: '<=', desc: 'TPR gap between groups. Should be â‰¤ 0.1', icon: 'accessibility' },
                { name: 'Predictive Equality', value: predEq, threshold: 0.1, direction: '<=', desc: 'FPR gap between groups. Should be â‰¤ 0.1', icon: 'rule' },
                { name: 'Equalized Odds', value: eqOdds, threshold: 0.1, direction: '<=', desc: 'Max of TPR and FPR gaps. Should be â‰¤ 0.1', icon: 'library_books' },
                { name: 'Theil Index', value: theilIndex, threshold: 0.1, direction: '<=', desc: 'Between-group inequality. Should be â‰¤ 0.1', icon: 'show_chart' },
                { name: 'Chi-Squared (Ï‡Â²)', value: chiSq, threshold: null, direction: null, desc: `Ï‡Â² = ${chiSq.toFixed(2)}, df = ${df}, p â‰ˆ ${chiPValue.toFixed(4)}`, icon: 'science' },
            ];

            const container = document.getElementById('fairnessMetrics');
            container.innerHTML = `
            <div class="space-y-3">
                ${rates.map(r => `
                    <div class="flex items-center justify-between">
                        <span class="text-sm text-slate-600 dark:text-slate-400 w-24">${r.name}</span>
                        <div class="flex-1 mx-3">
                            <div class="w-full h-3 rounded-full bg-slate-200 dark:bg-slate-700 overflow-hidden">
                                <div class="h-full rounded-full ${r.rate === maxRate ? 'bg-green-500' : r.rate === minRate ? 'bg-red-500' : 'bg-primary'}" style="width: ${(r.rate * 100).toFixed(0)}%"></div>
                            </div>
                        </div>
                        <span class="text-sm font-medium text-slate-800 dark:text-slate-200 w-16 text-right">${(r.rate * 100).toFixed(1)}%</span>
                    </div>
                `).join('')}
            </div>
            <hr class="border-slate-200 dark:border-slate-700 my-4"/>
            <div class="space-y-2">
                ${metrics.map(m => {
                const pass = m.direction === '>=' ? m.value >= m.threshold : m.direction === '<=' ? m.value <= m.threshold : null;
                const statusColor = pass === true ? 'text-green-500' : pass === false ? 'text-red-500' : 'text-slate-400';
                const badge = pass === true ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-green-500/20 text-green-500 ml-2">PASS</span>' : pass === false ? '<span class="text-[10px] px-1.5 py-0.5 rounded bg-red-500/20 text-red-500 ml-2">FAIL</span>' : '';
                return `<div class="flex justify-between items-center p-2 rounded-lg hover:bg-slate-50 dark:hover:bg-surface-dark-lighter">
                        <div class="flex items-center gap-2">
                            <span class="material-icons-outlined text-sm ${statusColor}">${m.icon}</span>
                            <div>
                                <p class="text-xs font-medium text-slate-700 dark:text-slate-300">${m.name}${badge}</p>
                                <p class="text-[10px] text-slate-400">${m.desc}</p>
                            </div>
                        </div>
                        <span class="text-sm font-bold ${statusColor}">${m.value.toFixed(3)}</span>
                    </div>`;
            }).join('')}
            </div>
            <div class="mt-3 p-3 rounded-lg ${metrics.filter(m => m.direction).every(m => m.direction === '>=' ? m.value >= m.threshold : m.value <= m.threshold) ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'}">
                <p class="text-xs font-bold ${metrics.filter(m => m.direction).every(m => m.direction === '>=' ? m.value >= m.threshold : m.value <= m.threshold) ? 'text-green-500' : 'text-red-500'}">
                    ${metrics.filter(m => m.direction).every(m => m.direction === '>=' ? m.value >= m.threshold : m.value <= m.threshold) ? 'âœ“ All metrics pass fairness thresholds' : 'âœ— ' + metrics.filter(m => m.direction && !(m.direction === '>=' ? m.value >= m.threshold : m.value <= m.threshold)).length + ' of ' + metrics.filter(m => m.direction).length + ' metrics fail fairness thresholds'}
                </p>
            </div>
        `;
        }

        // ==================== INTERSECTIONAL ANALYSIS ====================
        function renderIntersectionalAnalysis(protAttr, target) {
            // Find another categorical column for intersection
            const categoricalCols = currentColumns.filter(col => {
                const vals = new Set(currentData.map(r => r[col]));
                return vals.size <= 10 && vals.size >= 2 && col !== protAttr && col !== target;
            });

            const container = document.getElementById('intersectionalResults');
            if (categoricalCols.length === 0) {
                container.innerHTML = '<p class="text-sm text-slate-400">No additional categorical columns found for intersectional analysis.</p>';
                return;
            }

            const secondAttr = categoricalCols[0]; // use first available
            const targetVals = [...new Set(currentData.map(r => r[target]))];
            const positiveVal = targetVals.find(v => /approved|hired|low|yes|1|positive/i.test(String(v)));

            // Compute rates for each intersection
            const intersections = {};
            currentData.forEach(row => {
                const key = `${row[protAttr]} Ã— ${row[secondAttr]}`;
                if (!intersections[key]) intersections[key] = { total: 0, positive: 0 };
                intersections[key].total++;
                if (String(row[target]) === String(positiveVal)) intersections[key].positive++;
            });

            const crossRates = Object.entries(intersections)
                .filter(([_, v]) => v.total >= 5) // minimum sample size
                .map(([k, v]) => ({ name: k, rate: v.positive / v.total, n: v.total }))
                .sort((a, b) => a.rate - b.rate);

            if (crossRates.length === 0) {
                container.innerHTML = '<p class="text-sm text-slate-400">Insufficient data for intersectional analysis.</p>';
                return;
            }

            const maxCross = Math.max(...crossRates.map(r => r.rate));
            const minCross = Math.min(...crossRates.map(r => r.rate));
            const crossDI = maxCross > 0 ? minCross / maxCross : 1;

            container.innerHTML = `
                <p class="text-xs text-slate-400 mb-3">Intersecting <strong>${protAttr}</strong> Ã— <strong>${secondAttr}</strong></p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                    ${crossRates.map(r => {
                const color = r.rate === minCross ? 'border-red-500/30 bg-red-500/10' : r.rate === maxCross ? 'border-green-500/30 bg-green-500/10' : 'border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-surface-dark-lighter';
                return `<div class="p-3 rounded-lg border ${color}">
                            <p class="text-xs font-medium text-slate-700 dark:text-slate-300 truncate" title="${r.name}">${r.name}</p>
                            <p class="text-lg font-bold ${r.rate === minCross ? 'text-red-500' : r.rate === maxCross ? 'text-green-500' : 'text-slate-700 dark:text-slate-300'}">${(r.rate * 100).toFixed(1)}%</p>
                            <p class="text-[10px] text-slate-400">n=${r.n}</p>
                        </div>`;
            }).join('')}
                </div>
                <div class="mt-3 p-3 rounded-lg ${crossDI >= 0.8 ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'}">
                    <p class="text-xs font-bold ${crossDI >= 0.8 ? 'text-green-500' : 'text-red-500'}">
                        Intersectional Disparate Impact: ${crossDI.toFixed(3)} ${crossDI >= 0.8 ? '(PASS)' : '(FAIL â€” bias amplified at intersection)'}
                    </p>
                    <p class="text-[10px] text-slate-400 mt-1">Gap: ${crossRates[crossRates.length - 1]?.name} (${(maxCross * 100).toFixed(1)}%) vs ${crossRates[0]?.name} (${(minCross * 100).toFixed(1)}%)</p>
                </div>
            `;
        }

        function generateAlerts(protAttr, target) {
            const alerts = [];
            const counts = {};
            currentData.forEach(row => { const g = row[protAttr]; counts[g] = (counts[g] || 0) + 1; });
            const total = currentData.length;
            const groupNames = Object.keys(counts);

            // Check for severe underrepresentation
            groupNames.forEach(g => {
                const pct = (counts[g] / total * 100);
                if (pct < 15 && groupNames.length <= 5) {
                    alerts.push({ type: 'warning', text: `Group "${g}" represents only ${pct.toFixed(1)}% of the dataset â€” potential underrepresentation.` });
                }
            });

            // Check for class imbalance in target
            const targetCounts = {};
            currentData.forEach(row => { const t = row[target]; targetCounts[t] = (targetCounts[t] || 0) + 1; });
            const tVals = Object.keys(targetCounts);
            if (tVals.length === 2) {
                const ratio = Math.min(...Object.values(targetCounts)) / Math.max(...Object.values(targetCounts));
                if (ratio < 0.3) {
                    alerts.push({ type: 'caution', text: `Target variable is highly imbalanced (ratio: ${ratio.toFixed(2)}). Consider rebalancing before training.` });
                }
            }

            // Check disparate impact
            const groups = {};
            currentData.forEach(row => {
                const g = row[protAttr];
                if (!groups[g]) groups[g] = { total: 0, positive: 0 };
                groups[g].total++;
                const targetVals = [...new Set(currentData.map(r => r[target]))];
                const positiveVal = targetVals.find(v => /approved|hired|low|yes|1|positive/i.test(String(v)));
                if (String(row[target]) === String(positiveVal)) groups[g].positive++;
            });
            const rates = Object.entries(groups).map(([k, v]) => ({ name: k, rate: v.positive / v.total }));
            const maxR = Math.max(...rates.map(r => r.rate));
            const minR = Math.min(...rates.map(r => r.rate));
            if (minR / maxR < 0.8) {
                const disadvantaged = rates.find(r => r.rate === minR);
                const advantaged = rates.find(r => r.rate === maxR);
                alerts.push({ type: 'danger', text: `Disparate impact detected: "${disadvantaged.name}" has a ${(disadvantaged.rate * 100).toFixed(1)}% positive rate vs. "${advantaged.name}" at ${(advantaged.rate * 100).toFixed(1)}%. This fails the 80% rule.` });
            }

            const alertsDiv = document.getElementById('alerts');
            alertsDiv.innerHTML = alerts.map(a => {
                const colors = { warning: 'bg-yellow-500/10 border-yellow-500/30 text-yellow-600 dark:text-yellow-400', caution: 'bg-orange-500/10 border-orange-500/30 text-orange-600 dark:text-orange-400', danger: 'bg-red-500/10 border-red-500/30 text-red-600 dark:text-red-400' };
                const icons = { warning: 'warning', caution: 'error_outline', danger: 'dangerous' };
                return `<div class="flex items-start p-4 rounded-xl border ${colors[a.type]}">
                <span class="material-icons-outlined mr-3 mt-0.5">${icons[a.type]}</span>
                <p class="text-sm">${a.text}</p>
            </div>`;
            }).join('');
        }

        // ==================== EXPORT ====================
        function exportReport() {
            const protAttr = document.getElementById('protectedAttr').value;
            const target = document.getElementById('targetVar').value;
            const html = `<!DOCTYPE html><html><head><title>Bias Audit Report</title>
        <style>body{font-family:system-ui;max-width:800px;margin:2em auto;padding:0 1em;color:#1e293b}
        h1{color:#137fec}table{border-collapse:collapse;width:100%}th,td{border:1px solid #e2e8f0;padding:8px;text-align:left}
        th{background:#f1f5f9}.alert{padding:12px;border-radius:8px;margin:8px 0;background:#fef3c7;border:1px solid #fde68a}
        .danger{background:#fee2e2;border-color:#fca5a5}.pass{color:#16a34a;font-weight:bold}.fail{color:#dc2626;font-weight:bold}</style></head>
        <body><h1>ðŸ“Š Dataset Bias Audit Report</h1>
        <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
        <p><strong>Records:</strong> ${currentData.length} | <strong>Protected Attribute:</strong> ${protAttr} | <strong>Target:</strong> ${target}</p>
        <h2>Alerts</h2>${document.getElementById('alerts').innerHTML}
        <h2>Fairness Metrics</h2>${document.getElementById('fairnessMetrics').innerHTML}
        <p><em>Generated by AI Ethics Toolkit v2.1.0</em></p></body></html>`;
            const blob = new Blob([html], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'bias_audit_report.html';
            a.click();
        }
    </script>
</body>

</html>